<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Office Supply Request - Hyundai</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background-color:#f5f5f5;margin:0;padding:0
    }
    .hyundai-blue{background-color:#002c5f}
    .hyundai-blue-text{color:#002c5f}
    .hyundai-blue-border{border-color:#002c5f}
    @media print{body{background:white}.no-print{display:none!important}.print-only{display:block!important}}
  </style>
</head>

<body class="min-h-screen py-10 px-4">
  <div id="app"></div>

  <script>
    // ==========================
    // SUPPLY CATALOG
    // ==========================
    const SUPPLY_ITEMS = [
  {
    "key": "address_labels",
    "label": "Address Labels",
    "details": [
      {
        "key": "2_3_x_3_1_16",
        "label": "2/3\" x 3 1/16\""
      }
    ]
  },
  {
    "key": "batteries",
    "label": "Batteries",
    "details": [
      {
        "key": "aaa",
        "label": "AAA"
      },
      {
        "key": "aa",
        "label": "AA"
      },
      {
        "key": "c",
        "label": "C"
      },
      {
        "key": "d",
        "label": "D"
      }
    ]
  },
  {
    "key": "binder_clips",
    "label": "Binder Clips",
    "details": [
      {
        "key": "mini",
        "label": "Mini"
      },
      {
        "key": "small",
        "label": "Small"
      },
      {
        "key": "medium",
        "label": "Medium"
      },
      {
        "key": "large",
        "label": "Large"
      },
      {
        "key": "jumbo",
        "label": "Jumbo"
      }
    ]
  },
  {
    "key": "business_card_binder_pages_clear",
    "label": "Business Card Binder Pages Clear",
    "details": []
  },
  {
    "key": "business_envelopes_white",
    "label": "Business Envelopes White",
    "details": [
      {
        "key": "10",
        "label": "#10"
      }
    ]
  },
  {
    "key": "clear_front_notebooks_3_rings",
    "label": "Clear Front Notebooks 3 rings",
    "details": [
      {
        "key": "1",
        "label": "1\""
      },
      {
        "key": "1_1_2",
        "label": "1 1/2\""
      }
    ]
  },
  {
    "key": "clear_front_report_covers_3_hole",
    "label": "Clear Front Report Covers 3 hole",
    "details": [
      {
        "key": "blue",
        "label": "blue"
      },
      {
        "key": "black",
        "label": "black"
      },
      {
        "key": "dept_presentations",
        "label": "Dept. presentations"
      }
    ]
  },
  {
    "key": "clip_boards_letter_size",
    "label": "Clip Boards letter size",
    "details": [
      {
        "key": "hardboard",
        "label": "Hardboard"
      },
      {
        "key": "plastic",
        "label": "Plastic"
      }
    ]
  },
  {
    "key": "correction_tape",
    "label": "Correction Tape",
    "details": [
      {
        "key": "white",
        "label": "White"
      }
    ]
  },
  {
    "key": "desk_tape_dispenser",
    "label": "Desk Tape Dispenser",
    "details": [
      {
        "key": "scotch",
        "label": "Scotch"
      }
    ]
  },
  {
    "key": "easel_pad_flip_charts_2_pack",
    "label": "Easel Pad Flip Charts 2 Pack",
    "details": [
      {
        "key": "27_x_34",
        "label": "27\"  x  34\""
      }
    ]
  },
  {
    "key": "eraser_lion",
    "label": "Eraser - Lion",
    "details": []
  },
  {
    "key": "executive_desk_calculator",
    "label": "Executive Desk Calculator",
    "details": [
      {
        "key": "victor_1190",
        "label": "Victor 1190"
      },
      {
        "key": "victor_1180_34",
        "label": "Victor 1180-34"
      }
    ]
  },
  {
    "key": "expo_dry_erase_markers",
    "label": "Expo Dry Erase Markers",
    "details": [
      {
        "key": "multi_color_pack",
        "label": "Multi-color Pack"
      }
    ]
  },
  {
    "key": "expo_eraser",
    "label": "Expo Eraser",
    "details": [
      {
        "key": "eraser_only",
        "label": "eraser only"
      }
    ]
  },
  {
    "key": "expo_liquid_cleaner",
    "label": "Expo liquid cleaner",
    "details": [
      {
        "key": "8_oz_bottles",
        "label": "8 oz bottles"
      }
    ]
  },
  {
    "key": "extra_deep_desk_drawer_organizer_tray",
    "label": "Extra Deep Desk Drawer Organizer Tray",
    "details": []
  },
  {
    "key": "file_folder_labels",
    "label": "File Folder Labels",
    "details": [
      {
        "key": "0_66_x_3_44",
        "label": "0.66 x 3.44"
      }
    ]
  },
  {
    "key": "heavy_duty_box_sealing_tape",
    "label": "Heavy Duty Box Sealing Tape",
    "details": [
      {
        "key": "3_core_clear",
        "label": "3\" core Clear"
      }
    ]
  },
  {
    "key": "heavy_duty_stapler",
    "label": "Heavy Duty Stapler",
    "details": [
      {
        "key": "swigline_adm",
        "label": "Swigline/ Adm"
      },
      {
        "key": "bostich_w_h_emp",
        "label": "Bostich/ W/H Emp."
      }
    ]
  },
  {
    "key": "heavy_duty_staplers",
    "label": "Heavy Duty Staplers",
    "details": [
      {
        "key": "15_16_swingline",
        "label": "15/16\" Swingline"
      }
    ]
  },
  {
    "key": "heavy_weight_manilla_folders",
    "label": "Heavy Weight Manilla Folders",
    "details": [
      {
        "key": "reinforced_end_tab_with_fastener_finance_dept",
        "label": "Reinforced End Tab with fastener Finance Dept."
      }
    ]
  },
  {
    "key": "highlighters",
    "label": "Highlighters",
    "details": [
      {
        "key": "yellow",
        "label": "Yellow"
      },
      {
        "key": "blue",
        "label": "Blue"
      },
      {
        "key": "orange",
        "label": "Orange"
      },
      {
        "key": "green",
        "label": "Green"
      },
      {
        "key": "pink",
        "label": "Pink"
      }
    ]
  },
  {
    "key": "highlighters_multi_colored_pack",
    "label": "Highlighters Multi-colored Pack",
    "details": [
      {
        "key": "wide_chisel_tip",
        "label": "Wide Chisel Tip"
      }
    ]
  },
  {
    "key": "hole_puncher",
    "label": "Hole Puncher",
    "details": [
      {
        "key": "2_holes",
        "label": "2 holes"
      },
      {
        "key": "3_holes",
        "label": "3 holes"
      }
    ]
  },
  {
    "key": "inter_department_envelopes",
    "label": "Inter-Department Envelopes",
    "details": []
  },
  {
    "key": "jumbo_size_kraft_envelopes",
    "label": "Jumbo Size Kraft Envelopes",
    "details": [
      {
        "key": "finance",
        "label": "Finance"
      }
    ]
  },
  {
    "key": "kraft_file_folder_with_fastener",
    "label": "Kraft File Folder with fastener",
    "details": [
      {
        "key": "reception",
        "label": "Reception"
      }
    ]
  },
  {
    "key": "liquid_glue",
    "label": "Liquid Glue",
    "details": []
  },
  {
    "key": "manila_folder",
    "label": "Manila Folder",
    "details": [
      {
        "key": "multi_color",
        "label": "Multi-color"
      },
      {
        "key": "red",
        "label": "Red"
      },
      {
        "key": "green",
        "label": "Green"
      }
    ]
  },
  {
    "key": "mechanical_pencils",
    "label": "Mechanical Pencils",
    "details": [
      {
        "key": "0_7_refills",
        "label": "0.7 Refills"
      }
    ]
  },
  {
    "key": "non_studded_chair_mat",
    "label": "Non Studded Chair Mat",
    "details": [
      {
        "key": "hard_floors",
        "label": "Hard Floors"
      },
      {
        "key": "rug",
        "label": "Rug"
      }
    ]
  },
  {
    "key": "numerical_end_tab_file_folder_labels",
    "label": "Numerical End Tab File Folder Labels",
    "details": [
      {
        "key": "numbers_from_0_thrugh_10_finance_dept",
        "label": "Numbers from  0 thrugh 10 Finance Dept."
      }
    ]
  },
  {
    "key": "office_chairs",
    "label": "Office Chairs",
    "details": []
  },
  {
    "key": "office_scissors_8",
    "label": "Office Scissors 8\"",
    "details": [
      {
        "key": "stainless_steel",
        "label": "Stainless Steel"
      }
    ]
  },
  {
    "key": "others",
    "label": "Others",
    "details": []
  },
  {
    "key": "packing_tape_dispenser",
    "label": "Packing Tape Dispenser",
    "details": [
      {
        "key": "3_core",
        "label": "3\" core"
      }
    ]
  },
  {
    "key": "panel_board_report_covers_3_hole",
    "label": "Panel & Board Report Covers 3 hole",
    "details": [
      {
        "key": "blue",
        "label": "blue"
      },
      {
        "key": "black",
        "label": "black"
      },
      {
        "key": "new_hire_kits",
        "label": "New Hire Kits"
      }
    ]
  },
  {
    "key": "paper_clips",
    "label": "Paper Clips",
    "details": [
      {
        "key": "small",
        "label": "Small"
      },
      {
        "key": "large",
        "label": "Large"
      }
    ]
  },
  {
    "key": "paper_fasteners_2_piece_2_prong",
    "label": "Paper Fasteners - 2 piece 2 prong",
    "details": [
      {
        "key": "2",
        "label": "2\""
      }
    ]
  },
  {
    "key": "paper_for_printers",
    "label": "Paper for Printers",
    "details": []
  },
  {
    "key": "paper_shredder",
    "label": "Paper Shredder",
    "details": []
  },
  {
    "key": "pencil_sharpener_bostich",
    "label": "Pencil Sharpener Bostich",
    "details": [
      {
        "key": "black",
        "label": "Black"
      },
      {
        "key": "beige",
        "label": "Beige"
      }
    ]
  },
  {
    "key": "pencils",
    "label": "Pencils",
    "details": [
      {
        "key": "2",
        "label": "#2"
      }
    ]
  },
  {
    "key": "permanent_markers",
    "label": "Permanent  Markers",
    "details": [
      {
        "key": "red",
        "label": "Red"
      },
      {
        "key": "black",
        "label": "Black"
      },
      {
        "key": "broad_chisel_w_h_inventory",
        "label": "Broad Chisel W/H Inventory"
      }
    ]
  },
  {
    "key": "post_it_notes_multi_colored",
    "label": "Post-it-notes multi colored",
    "details": [
      {
        "key": "3_x_3",
        "label": "3\"  x  3\""
      },
      {
        "key": "2_x_1_5",
        "label": "2\"  x  1.5\""
      }
    ]
  },
  {
    "key": "post_it_notes_yellow",
    "label": "Post-It-Notes Yellow",
    "details": [
      {
        "key": "3_x_3",
        "label": "3\"  x  3\""
      },
      {
        "key": "2_x_1_5",
        "label": "2\"  x  1.5\""
      }
    ]
  },
  {
    "key": "premium_ruled_writing_pads",
    "label": "Premium Ruled Writing Pads",
    "details": [
      {
        "key": "5_x_8",
        "label": "5\" x 8\""
      },
      {
        "key": "8_5_x_11",
        "label": "8.5\" x  11\""
      }
    ]
  },
  {
    "key": "pressboard_folders_with_fasteners",
    "label": "Pressboard Folders with fasteners",
    "details": [
      {
        "key": "2_dividers_6_fasteners_3_expansion_grey_hdg_hr",
        "label": "2 dividers 6 fasteners 3\" expansion Grey HdG HR"
      }
    ]
  },
  {
    "key": "redi_seal_catalogue_envelopes",
    "label": "Redi Seal Catalogue Envelopes",
    "details": []
  },
  {
    "key": "redrope_expanding_file_pockets",
    "label": "Redrope Expanding File Pockets",
    "details": [
      {
        "key": "5_25_expansion",
        "label": "5.25\" expansion"
      }
    ]
  },
  {
    "key": "rubber_bands",
    "label": "Rubber Bands",
    "details": [
      {
        "key": "117",
        "label": "#117"
      },
      {
        "key": "117b",
        "label": "#117B"
      },
      {
        "key": "19",
        "label": "#19"
      },
      {
        "key": "16",
        "label": "#16"
      },
      {
        "key": "107",
        "label": "#107"
      }
    ]
  },
  {
    "key": "ruler_12",
    "label": "Ruler - 12\"",
    "details": [
      {
        "key": "metal",
        "label": "Metal"
      },
      {
        "key": "wood",
        "label": "Wood"
      },
      {
        "key": "clear_plastic",
        "label": "Clear Plastic"
      }
    ]
  },
  {
    "key": "sharpie_markers",
    "label": "Sharpie Markers",
    "details": [
      {
        "key": "red",
        "label": "Red"
      },
      {
        "key": "black",
        "label": "Black"
      },
      {
        "key": "chisel_tip_med",
        "label": "Chisel Tip Med"
      },
      {
        "key": "fine_point",
        "label": "Fine Point"
      },
      {
        "key": "extra_fine_point",
        "label": "Extra Fine Point"
      }
    ]
  },
  {
    "key": "side_load_desk_trays",
    "label": "Side Load Desk Trays",
    "details": [
      {
        "key": "letter_size",
        "label": "Letter Size"
      }
    ]
  },
  {
    "key": "sign_here_arrow_flags",
    "label": "Sign Here -  Arrow Flags",
    "details": [
      {
        "key": "multi_colored_packs",
        "label": "multi- colored packs"
      }
    ]
  },
  {
    "key": "sign_here_flags",
    "label": "Sign Here Flags",
    "details": [
      {
        "key": "yellow",
        "label": "Yellow"
      }
    ]
  },
  {
    "key": "sortkwik_fingertip_moistener",
    "label": "Sortkwik Fingertip Moistener",
    "details": [
      {
        "key": "7_75_oz",
        "label": "7.75 oz"
      },
      {
        "key": "0_38_oz",
        "label": "0.38 oz"
      }
    ]
  },
  {
    "key": "stamp_pad",
    "label": "Stamp Pad",
    "details": [
      {
        "key": "red",
        "label": "Red"
      },
      {
        "key": "black",
        "label": "Black"
      }
    ]
  },
  {
    "key": "stamp_pad_ink_bottle",
    "label": "Stamp Pad Ink Bottle",
    "details": [
      {
        "key": "red",
        "label": "Red"
      },
      {
        "key": "black",
        "label": "Black"
      }
    ]
  },
  {
    "key": "stapler_remover",
    "label": "Stapler remover",
    "details": [
      {
        "key": "jaw_style",
        "label": "Jaw Style"
      },
      {
        "key": "wand_style",
        "label": "Wand Style"
      }
    ]
  },
  {
    "key": "staplers",
    "label": "Staplers",
    "details": [
      {
        "key": "swigline_adm",
        "label": "Swigline/ Adm"
      },
      {
        "key": "bostich_employees",
        "label": "Bostich/Employees"
      }
    ]
  },
  {
    "key": "staples",
    "label": "Staples",
    "details": [
      {
        "key": "standard",
        "label": "Standard"
      }
    ]
  },
  {
    "key": "storage_file_bankers_box",
    "label": "Storage File Bankers Box",
    "details": []
  },
  {
    "key": "tab_dividers",
    "label": "Tab Dividers",
    "details": [
      {
        "key": "a_to_z",
        "label": "A to Z"
      },
      {
        "key": "numbered",
        "label": "Numbered"
      },
      {
        "key": "ready_indez_dividers_if50544",
        "label": "Ready Indez Dividers IF50544"
      }
    ]
  },
  {
    "key": "telescoping_easel_3_legs",
    "label": "Telescoping Easel (3 legs)",
    "details": [
      {
        "key": "with_pad_retainer",
        "label": "with pad retainer"
      }
    ]
  },
  {
    "key": "top_load_sheet_protectors",
    "label": "Top Load Sheet Protectors",
    "details": [
      {
        "key": "heavyweight",
        "label": "Heavyweight"
      }
    ]
  },
  {
    "key": "transparent_tape",
    "label": "Transparent Tape",
    "details": [
      {
        "key": "1_core",
        "label": "1\"core"
      }
    ]
  },
  {
    "key": "tze_laminated_labels",
    "label": "Tze Laminated Labels",
    "details": [
      {
        "key": "1_white_tape",
        "label": "1\" white tape"
      },
      {
        "key": "1_clear_tape",
        "label": "1\"  clear tape"
      }
    ]
  },
  {
    "key": "other",
    "label": "Other",
    "details": []
  }
];

    // ==========================
    // STATE
    // ==========================
    const state = {
      formData: {
        name: '',
        date: '',
        department: '',
        position: '',
        contactExt: '',
        email: ''
      },
      requestedItems: [] // { id, itemKey, detailKey, quantity }
    };

    // ==========================
    // HELPERS
    // ==========================
    function todayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function formatDisplayDate(iso) {
      if (!iso) return '';
      const [y, m, d] = iso.split('-');
      return `${m}/${d}/${y}`;
    }

    function safeFilenamePart(str) {
      return String(str || '')
        .trim()
        .replace(/[\/\\:*?"<>|]/g, '')
        .replace(/\s+/g, '_')
        .replace(/_+/g, '_')
        .slice(0, 60) || 'User';
    }

    function updateFormData(field, value) {
      state.formData[field] = value;
    }

    
    function getItemByKey(key) {
      return SUPPLY_ITEMS.find(x => String(x.key) === String(key));
    }

    function getDetailLabel(itemKey, detailKey) {
      const item = getItemByKey(itemKey);
      if (!item || !Array.isArray(item.details)) return '';
      const d = item.details.find(x => String(x.key) === String(detailKey));
      return d ? d.label : '';
    }

    function itemRequiresDetail(itemKey) {
      const item = getItemByKey(itemKey);
      return !!(item && Array.isArray(item.details) && item.details.length > 0);
    }

    function getLineDescription(row) {
      const item = getItemByKey(row.itemKey);
      if (!item) return '';
      // Special case: Other = free text in row.detailKey
      const detail = row.detailKey
        ? (row.itemKey === 'other' ? row.detailKey : getDetailLabel(row.itemKey, row.detailKey))
        : '';
      return detail ? `${item.label} - ${detail}` : `${item.label}`;
    }


    function buildItemOptions(selectedKey) {
      return SUPPLY_ITEMS.map(it => `
        <option value="${it.key}" ${String(selectedKey) === String(it.key) ? 'selected' : ''}>${it.label}</option>
      `).join('');
    }

    function buildDetailOptions(itemKey, selectedDetailKey) {
      const item = getItemByKey(itemKey);
      if (!item || !Array.isArray(item.details) || item.details.length === 0) {
        return `<option value="">—</option>`;
      }
      return [
        `<option value="">Select detail.</option>`,
        ...item.details.map(d => `
          <option value="${d.key}" ${String(selectedDetailKey) === String(d.key) ? 'selected' : ''}>${d.label}</option>
        `)
      ].join('');
    }

    // Silent clear (no confirm) – used after submit
    function clearFormSilent() {
      state.formData = { name: '', date: '', department: '', position: '', contactExt: '', email: '' };
      state.requestedItems = [];
      state.formData.date = todayISO();
      render();
    }

    // ==========================
    // RENDER
    // ==========================
    function render() {
      const app = document.getElementById('app');

      app.innerHTML = `
        <div class="max-w-5xl mx-auto bg-white shadow-2xl rounded-lg overflow-hidden">
          <!-- Header -->
          <div class="hyundai-blue p-6">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center">
                  <span class="hyundai-blue-text font-black text-xl">H</span>
                </div>
                <div>
                  <h1 class="text-2xl md:text-3xl font-extrabold text-white tracking-wide">OFFICE SUPPLY REQUEST</h1>
                  <p class="text-blue-100 text-sm mt-1">Sojitz de Puerto Rico</p>
                </div>
              </div>
              <!-- Request Date removed -->
            </div>
          </div>

          <!-- Content -->
          <div class="p-6 md:p-8">
            <!-- REQUESTER INFORMATION -->
            <div class="mb-8">
              <h2 class="text-lg font-extrabold hyundai-blue-text uppercase tracking-wider mb-4 border-b pb-2">
                Requester Information
              </h2>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label for="name" class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Full Name *</label>
                  <input type="text" id="name" required value="${state.formData.name}"
                    class="w-full px-4 py-3 border-2 border-gray-300 focus:border-blue-900 focus:outline-none transition-colors"
                    placeholder="John Doe">
                </div>

                <div>
                  <label for="date" class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Date</label>
                  <input type="date" id="date"
                    value="${todayISO()}" min="${todayISO()}" max="${todayISO()}" readonly
                    class="w-full px-4 py-3 border-2 border-gray-300 focus:border-blue-900 focus:outline-none transition-colors bg-gray-50 cursor-not-allowed">
                </div>

                <div>
                  <label for="department" class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Department *</label>
                  <select id="department" required
                    class="w-full px-4 py-3 border-2 border-gray-300 focus:border-blue-900 focus:outline-none transition-colors">
                    <option value="">Select a department...</option>
                    <option value="Human Resources" ${state.formData.department === 'Human Resources' ? 'selected' : ''}>Human Resources</option>
                    <option value="Information Technology" ${state.formData.department === 'Information Technology' ? 'selected' : ''}>Information Technology</option>
                    <option value="Services" ${state.formData.department === 'Services' ? 'selected' : ''}>Services</option>
                    <option value="Parts" ${state.formData.department === 'Parts' ? 'selected' : ''}>Parts</option>
                    <option value="Dealer Development" ${state.formData.department === 'Dealer Development' ? 'selected' : ''}>Dealer Development</option>
                    <option value="Administration" ${state.formData.department === 'Administration' ? 'selected' : ''}>Administration</option>
                  </select>
                </div>

                <div>
                  <label for="position" class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Position *</label>
                  <input type="text" id="position" required value="${state.formData.position}"
                    class="w-full px-4 py-3 border-2 border-gray-300 focus:border-blue-900 focus:outline-none transition-colors"
                    placeholder="e.g., Analyst">
                </div>

                <div>
                  <label for="contactExt" class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Extension</label>
                  <input type="text" id="contactExt" value="${state.formData.contactExt}"
                    inputmode="numeric" pattern="\\d{4}" minlength="4" maxlength="4"
                    class="w-full px-4 py-3 border-2 border-gray-300 focus:border-blue-900 focus:outline-none transition-colors"
                    placeholder="e.g. 1234" title="Extension must be 4 digits (e.g., 1234)">
                </div>

                <div>
                  <label for="email" class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Email *</label>
                  <input type="email" id="email" required value="${state.formData.email}"
                    class="w-full px-4 py-3 border-2 border-gray-300 focus:border-blue-900 focus:outline-none transition-colors"
                    placeholder="johndoe@hyundaipr.com">
                </div>
              </div>
            </div>

            <!-- SUPPLY REQUEST -->
            <div class="mb-8">
              <div class="flex items-center justify-between mb-4 border-b pb-2">
                <h2 class="text-lg font-extrabold hyundai-blue-text uppercase tracking-wider">Supply Request</h2>
                <button id="addItemBtn" type="button"
                  class="hyundai-blue text-white px-5 py-2 rounded-lg font-bold tracking-wide hover:opacity-90 transition-opacity">
                  + Add Item
                </button>
              </div>

              <div class="overflow-x-auto">
                ${
                  state.requestedItems.length === 0
                    ? `<div class="text-center py-10 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg">
                         <p class="text-gray-500 font-medium">No items in your request. Click "Add Item" to begin.</p>
                       </div>`
                    : `
                      <table class="w-full border-collapse">
                        <thead>
                          <tr class="bg-gray-50 border-b-2 border-gray-300">
                            <th class="text-left py-3 px-4 font-bold text-gray-700 uppercase text-sm">Item</th>
                            <th class="text-left py-3 px-4 font-bold text-gray-700 uppercase text-sm">Detail</th>
                            <th class="text-center py-3 px-4 font-bold text-gray-700 uppercase text-sm w-32">Quantity</th>
                            <th class="w-20"></th>
                          </tr>
                        </thead>
                        <tbody>
                          ${state.requestedItems.map((item) => `
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                              <td class="py-3 px-4">
                                <select id="item-${item.id}" class="w-full px-3 py-2 border-2 border-gray-300 focus:border-blue-900 focus:outline-none transition-colors" required>
                                  <option value="">Select an item.</option>
                                  ${buildItemOptions(item.itemKey)}
                                </select>
                              </td>
                              <td class="py-3 px-4">
                                ${
                                  item.itemKey === 'other'
                                    ? `<input id="detail-${item.id}" type="text" placeholder="Describe the item" value="${item.detailKey || ''}"
                                        class="w-full px-3 py-2 border-2 border-gray-300 focus:border-blue-900 focus:outline-none transition-colors" required>`
                                    : `<select id="detail-${item.id}" class="w-full px-3 py-2 border-2 border-gray-300 focus:border-blue-900 focus:outline-none transition-colors" ${itemRequiresDetail(item.itemKey) ? 'required' : ''} ${itemRequiresDetail(item.itemKey) ? '' : 'disabled'}>
                                        ${buildDetailOptions(item.itemKey, item.detailKey)}
                                      </select>`
                                }
                              </td>
                              <td class="py-3 px-4">
                                <input type="number" min="1" step="1" value="${item.quantity}" id="qty-${item.id}"
                                  class="w-full px-3 py-2 border-2 border-gray-300 focus:border-blue-900 focus:outline-none transition-colors text-center">
                              </td>
                              <td class="py-3 px-4 text-center">
                                <button type="button" class="removeBtn px-3 py-2 text-red-700 font-bold hover:bg-red-50 rounded transition-colors" data-id="${item.id}">
                                  Remove
                                </button>
                              </td>
                            </tr>
                          `).join('')}
                        </tbody>
                      </table>
                    `
                }
              </div>
            </div>

            <!-- Buttons -->
            <div class="flex flex-col md:flex-row gap-4 justify-end no-print">
              <button id="clearBtn" type="button"
                class="px-6 py-3 rounded-lg font-bold tracking-wide border-2 border-gray-300 hover:border-gray-400 transition-colors">
                Clear Form
              </button>

              <button id="submitBtn" type="button"
                class="hyundai-blue text-white px-8 py-3 rounded-lg font-extrabold tracking-wide hover:opacity-90 transition-opacity">
                Submit Request
              </button>
            </div>
          </div>

          <!-- Footer -->
          <div class="p-4 bg-gray-100 text-center text-xs text-gray-600">
            For internal use only • Sojitz de Puerto Rico • Generated on ${formatDisplayDate(todayISO())}
          </div>
        </div>
      `;

      // ==========================
      // EVENTS
      // ==========================
      document.getElementById('name')?.addEventListener('input', (e) => updateFormData('name', e.target.value));
      document.getElementById('department')?.addEventListener('change', (e) => updateFormData('department', e.target.value));
      document.getElementById('position')?.addEventListener('input', (e) => updateFormData('position', e.target.value));
      document.getElementById('email')?.addEventListener('input', (e) => updateFormData('email', e.target.value));

      // Extension: numeric only, max 4
      document.getElementById('contactExt')?.addEventListener('input', (e) => {
        const digitsOnly = String(e.target.value || '').replace(/\D/g, '').slice(0, 4);
        e.target.value = digitsOnly;
        updateFormData('contactExt', digitsOnly);
      });

      document.getElementById('addItemBtn')?.addEventListener('click', addItemRow);
      document.getElementById('clearBtn')?.addEventListener('click', handleClearForm);
      document.getElementById('submitBtn')?.addEventListener('click', handleSubmit);

      // Wire per-row events
      state.requestedItems.forEach((it) => {
        const sel = document.getElementById(`item-${it.id}`);
        const detail = document.getElementById(`detail-${it.id}`);
        const qty = document.getElementById(`qty-${it.id}`);

        sel?.addEventListener('change', (e) => {
          const row = state.requestedItems.find(x => x.id === it.id);
          if (row) { row.itemKey = e.target.value; row.detailKey = ''; render(); }
        });

        ['change','input'].forEach((evt) => {
          detail?.addEventListener(evt, (e) => {
            const row = state.requestedItems.find(x => x.id === it.id);
            if (row) row.detailKey = e.target.value;
          });
        });

        qty?.addEventListener('input', (e) => {
          const row = state.requestedItems.find(x => x.id === it.id);
          if (row) row.quantity = e.target.value;
        });
      });

      document.querySelectorAll('.removeBtn')?.forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = Number(e.target.getAttribute('data-id'));
          removeItem(id);
        });
      });
    }

    // ==========================
    // ITEMS
    // ==========================
    function addItemRow() {
      state.requestedItems.push({
        id: Date.now() + Math.floor(Math.random() * 1000),
        itemKey: '',
        detailKey: '',
        quantity: 1
      });
      render();
    }

    function removeItem(id) {
      state.requestedItems = state.requestedItems.filter(x => x.id !== id);
      render();
    }

    // ==========================
    // CLEAR (manual)
    // ==========================
    function handleClearForm() {
      if (!confirm('Clear the form?')) return;
      clearFormSilent();
    }

    // ==========================
    // PDF (FORM STYLE 1:1)
    // ==========================
    function generateAndDownloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format: 'letter' }); // 216 x 279 mm

      // Page metrics
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 14;

      const iso = todayISO();
      const dateStr = formatDisplayDate(iso);

      // Title
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(20);
      doc.text('OFFICE SUPPLIES REQUISITION FORM', pageW / 2, 18, { align: 'center' });

      // REQUESTER INFORMATION
      let y = 30;
      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.text('REQUESTER INFORMATION', margin, y);

      y += 8;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);

      // Name / Date
      doc.text(`Name: ${state.formData.name || ''}`, margin, y);
      doc.text(`Date: ${dateStr}`, pageW / 2, y);

      // Department / Position
      y += 7;
      doc.text(`Department: ${state.formData.department || ''}`, margin, y);
      doc.text(`Position: ${state.formData.position || ''}`, pageW / 2, y);

      // Extension / Email
      y += 7;
      doc.text(`Extension: ${state.formData.contactExt || ''}`, margin, y);
      doc.text(`Email: ${state.formData.email || ''}`, pageW / 2, y);

      // REQUESTED ITEMS
      y += 12;
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      doc.text('REQUESTED ITEMS', margin, y);

      // Table setup
      y += 6;
      const tableX = margin;
      const tableW = pageW - margin * 2;
      const qtyColW = 30;
      const detailColW = 60;
      const itemColW = tableW - qtyColW - detailColW;

      const headerH = 8;
      const rowH = 8;

      // Header row
      doc.setDrawColor(0);
      doc.setLineWidth(0.2);

      // Header rect
      doc.rect(tableX, y, tableW, headerH);
      // Column splits
      doc.line(tableX + itemColW, y, tableX + itemColW, y + headerH);
      doc.line(tableX + itemColW + detailColW, y, tableX + itemColW + detailColW, y + headerH);

      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      doc.text('Item', tableX + 2, y + 5.6);
      doc.text('Detail', tableX + itemColW + 2, y + 5.6);
      doc.text('Quantity', tableX + itemColW + detailColW + qtyColW / 2, y + 5.6, { align: 'center' });

      // Rows
      doc.setFont('helvetica', 'normal');
      let rowsY = y + headerH;

      const rows = state.requestedItems.map((it, idx) => ({
        n: idx + 1,
        item: getItemByKey(it.itemKey)?.label || '',
        detail: it.detailKey ? (it.itemKey === 'other' ? it.detailKey : getDetailLabel(it.itemKey, it.detailKey)) : '',
        qty: String(it.quantity || '')
      }));

      if (rows.length === 0) {
        // at least one empty row to match form style
        doc.rect(tableX, rowsY, tableW, rowH);
        doc.line(tableX + itemColW, rowsY, tableX + itemColW, rowsY + rowH);
        doc.line(tableX + itemColW + detailColW, rowsY, tableX + itemColW + detailColW, rowsY + rowH);
      } else {
        rows.forEach((r) => {
          // Page break handling (simple): if close to bottom, add new page and re-draw table header
          if (rowsY + rowH + 60 > pageH) {
            doc.addPage();
            y = 18;

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text('OFFICE SUPPLIES REQUISITION FORM', pageW / 2, y, { align: 'center' });

            y = 30;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('REQUESTED ITEMS', margin, y);

            y += 6;
            doc.rect(tableX, y, tableW, headerH);
            doc.line(tableX + itemColW, y, tableX + itemColW, y + headerH);
            doc.line(tableX + itemColW + detailColW, y, tableX + itemColW + detailColW, y + headerH);

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('Item', tableX + 2, y + 5.6);
            doc.text('Detail', tableX + itemColW + 2, y + 5.6);
            doc.text('Quantity', tableX + itemColW + detailColW + qtyColW / 2, y + 5.6, { align: 'center' });

            doc.setFont('helvetica', 'normal');
            rowsY = y + headerH;
          }

          doc.rect(tableX, rowsY, tableW, rowH);
          doc.line(tableX + itemColW, rowsY, tableX + itemColW, rowsY + rowH);
          doc.line(tableX + itemColW + detailColW, rowsY, tableX + itemColW + detailColW, rowsY + rowH);

          const itemText = `${r.n}. ${r.item}`;
          doc.text(itemText, tableX + 2, rowsY + 5.6);
          doc.text(r.detail || '', tableX + itemColW + 2, rowsY + 5.6);
          doc.text(r.qty, tableX + itemColW + detailColW + qtyColW / 2, rowsY + 5.6, { align: 'center' });

          rowsY += rowH;
        });
      }

      // FOR ADMINISTRATION USE ONLY
      let adminY = rowsY + 12;
      if (adminY + 35 > pageH - 15) {
        doc.addPage();
        adminY = 30;
      }

      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      doc.text('FOR ADMINISTRATION USE ONLY', margin, adminY);

      adminY += 9;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);

      doc.text('AVP Approval: _______________________   Date: _______________', margin, adminY);
      adminY += 9;
      doc.text('Processed By: _______________________   Completion Date: _______________', margin, adminY);

      // Footer
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);
      doc.text('Sojitz de Puerto Rico dba Hyundai de Puerto Rico', pageW / 2, pageH - 12, { align: 'center' });

      const filename = `Supply_Request_${safeFilenamePart(state.formData.name)}_${iso}.pdf`;
      doc.save(filename);
    }

    // ==========================
    // SUBMIT (downloads PDF automatically + clears form)
    // ==========================
    function handleSubmit() {
      const nameEl = document.getElementById('name');
      const deptEl = document.getElementById('department');
      const posEl  = document.getElementById('position');
      const emailEl= document.getElementById('email');

      // Native validation
      if (![nameEl, deptEl, posEl, emailEl].every(el => el && el.checkValidity())) {
        const firstInvalid = [nameEl, deptEl, posEl, emailEl].find(el => el && !el.checkValidity());
        firstInvalid?.reportValidity();
        return;
      }

      // Date ALWAYS today
      state.formData.date = todayISO();

      // Validate items
      if (state.requestedItems.length === 0) {
        alert('Please add at least one item to your request.');
        return;
      }

      // Ensure all rows have item selected and valid qty
      const badRow = state.requestedItems.find(it =>
        !it.itemKey ||
        !it.quantity ||
        Number(it.quantity) < 1 ||
        (itemRequiresDetail(it.itemKey) && !it.detailKey) || (it.itemKey === 'other' && !String(it.detailKey || '').trim())
      );
      if (badRow) {
        alert('Please select an item, select a detail when required, and enter a valid quantity for each line.');
        return;
      }

      // 1) Auto-download PDF (1:1 form style)
      generateAndDownloadPDF();

      // 2) Email content (kept as-is for now)
      const subject = encodeURIComponent(`Office Supply Request Submitted`);
      const bodyLines = [
        `Dear Administration,`,
        ``,
        `I hope you are doing well. A new office supply request has been submitted.`,
        ``,
        `REQUESTER INFORMATION:`,
        `Name: ${state.formData.name}`,
        `Date: ${formatDisplayDate(state.formData.date)}`,
        ``,
        `REQUESTED ITEMS:`,
        ...state.requestedItems.map((it, idx) => `${idx + 1}. ${getLineDescription(it)} - Quantity: ${it.quantity}`),
        ``,
        `I've attached the detailed PDF to this email.`,
        `Best regards,`,
        `Office Supply System`
      ];

      const body = encodeURIComponent(bodyLines.join('\n'));

      // Change recipient as needed
      const recipient = 'supplies@hyundaipr.com';
      window.location.href = `mailto:${recipient}?subject=${subject}&body=${body}`;

      // 3) Auto clear after submit
      setTimeout(() => {
        clearFormSilent();
      }, 350);
    }

    // ==========================
    // INIT
    // ==========================
    state.formData.date = todayISO();
    render();
  </script>
</body>
</html>
